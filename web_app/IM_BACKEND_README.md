**IM 后端集成指南（网易云信 · 用户-机器人聊天）**
- **目标**: 在现有 Django 项目中接入网易云信（NIM）作为消息通道，实现“用户-机器人”聊天。本文仅说明后端应做的工作与难度评估。
- **关联代码**: 机器人回复逻辑复用 `generate_stream_response()`，位置见 [web_app/advisor/views.py](web_app/advisor/views.py)。

**关键概念**
- **accid**: 云信侧用户唯一账号标识。建议用你站内用户ID或加前缀的ID生成，后端调用云信服务端接口创建，一次性且幂等。
- **token**: 云信签发的短期登录凭证。前端 SDK 需要 `accid + token` 才能登录云信。后端负责向云信申请并刷新 token，永远不要把 AppSecret 暴露给前端。
- **机器人账号**: 固定的 `accid`（例如 `advisor_bot`）。消息由后端通过云信服务端 API 发送，机器人不需要用前端 SDK 登录。
- **消息抄送回调**: 云信向你后端回调用户消息事件。你在此处读取用户发给机器人的文本，调用 `generate_stream_response()` 获取分段输出，再用“自定义消息”逐段推送回用户，实现流式体验。

**后端职责（必须做）**
- **账号创建**: 为站内用户在云信侧创建 `accid`（一次性，幂等）。
- **凭证发放/刷新**: 基于 `accid` 向云信申请 `token`，返回给前端使用（登录/重连）。
- **回调处理**: 接收云信“消息抄送回调”，当消息目标是机器人账号时，触发你现有的生成逻辑并回发分段消息。
- **消息发送**: 使用云信服务端 API 向用户发送文本或自定义消息（推荐自定义消息用于“流式”）。
- **安全治理**: 校验回调来源、签名/白名单、限流、内容合规；必要时记录消息日志与故障审计。

**接口约定（后端提供）**
- **POST /im/register**: 输入站内用户标识，创建/刷新该用户在云信的 `accid` 与 `token`。前端拿到后用 SDK 登录。
  - 输入: `{"user_id": "<你的站内用户ID>", "name": "可选昵称"}`
  - 输出: `{"accid": "...", "token": "...", "bot": "advisor_bot"}`
- **POST /im/callback**: 云信“消息抄送回调”入口。仅在收到用户发给机器人账号的文本消息时处理，逐段回发生成结果（自定义消息）。
  - 输入: 云信回调事件 JSON（字段名可能包含 `from`/`fromAccid`、`to`/`toAccid`、`type`、`body.msg` 等）。
  - 输出: `{"ok": true}`（处理成功即可）。

**配置项**
- **环境变量**:
  - `NIM_APP_KEY`: 云信应用 AppKey
  - `NIM_APP_SECRET`: 云信应用 AppSecret（仅后端持有）
  - `NIM_BOT_ACCID`: 机器人账号 `accid`（如 `advisor_bot`）
- **回调 URL**: 在云信控制台配置“消息抄送回调”为 `https://你的域名/im/callback`（或本地代理测试地址）。

**数据流（文字说明，无图）**
- 用户登录你的站内系统 → 前端调用 `POST /im/register` → 后端创建/刷新 `accid` 并返回 `token`。
- 前端使用云信 SDK 通过 `accid + token` 登录 → 发文本消息到机器人 `NIM_BOT_ACCID`。
- 云信将该消息事件回调到 `POST /im/callback` → 后端识别目标为机器人 → 调用 [web_app/advisor/views.py](web_app/advisor/views.py) 中的 `generate_stream_response()`，拿到分段输出。
- 后端将每个分段以“自定义消息”回发给用户；最后发送一个 `done` 标记，即完成一次流式对话。

**安全与合规**
- **密钥保护**: `NIM_APP_SECRET` 仅在后端使用（服务端请求云信），绝不下发到前端。
- **回调校验**: 配置 IP 白名单或签名校验，拒绝非云信来源的请求。
- **限流与防滥用**: 对 `register` 与回调处理做基础限流；必要时对消息内容做合规审查。
- **日志追踪**: 记录关键事件（注册、回调、失败重试）以便排障与审计。

**测试与验证（实施后可用）**
- **获取凭证（注册）**:
```powershell
# Windows PowerShell 示例（站内登录后调用你后端）
Invoke-RestMethod -Uri http://localhost:8000/im/register -Method Post -ContentType 'application/json' -Body '{"user_id":"u_123","name":"Alice"}'
```
- **前端登录与聊天**: 前端用返回的 `accid + token` 登录云信 SDK，发送文本给机器人；观察自定义消息分段回显。
- **回调联通**: 在控制台将“消息抄送回调”指向你的 `POST /im/callback`，本地开发可使用内网穿透（如 `ngrok`）测试。

**难度评估与时间**
- **复杂度**: 中低（以官方 REST API 为主）。核心在于接口编排与安全校验，业务侧复用现有生成逻辑。
- **预估工期**: 
  - 最小可用（开发/联通/自测）: 0.5–1 天
  - 强化（签名校验、日志、限流、告警）: 1–2 天
- **常见坑**:
  - `token` 有有效期：前端断线或过期需重新调用 `register` 刷新。
  - 回调字段差异：云信不同类型事件字段名略有不同，需做兼容解析。
  - 推送频次与大小：自定义消息分段需控制频率与体积，避免触发限流。

**落地清单（后端）**
- **接口**: 实现 `POST /im/register` 与 `POST /im/callback`。
- **封装**: 统一云信服务端 API 调用（创建用户、刷新 token、发送文本/自定义消息）。
- **桥接**: 将回调中的用户提问转交 `generate_stream_response()` 并按分段推送。
- **配置**: 管理 `NIM_APP_KEY/SECRET/BOT_ACCID`，并在云信控制台设置回调与白名单。
- **监控**: 添加基础日志与错误告警，便于运维。

**后续建议**
- 若需要会话持久化与多端同步，建议将会话历史存入数据库或 Redis（参考 [web_app/advisor/views.py](web_app/advisor/views.py) 的 `SESSION_STORE` 结构）。
- 若扩展到“用户-用户”聊天，只需把回调处理逻辑改为透传或做审核，不必走机器人生成器。

如需我直接在项目里新增 `im_bridge` 的最小实现（接口与服务封装），告诉我即可，我可以把它接到你的现有视图与模板中。