# V3 版本技术汇报：命理数据集成

**日期：** 2025年12月8日  
**版本：** V3.0  
**核心功能：** 集成 Bazi MCP 工具，实现基于用户八字的个性化五行分析

---

## 一、版本迭代背景

### 1.1 现状分析
**V2 版本问题：**
- 五行分析是通用性的，缺乏个性化
- 无法根据用户实际命理特征提供精准建议
- 回答千篇一律，用户体验单一

### 1.2 改进目标
实现**命理数据驱动的个性化五行分析**：
- 用户输入生辰八字 → 系统自动排盘
- 基于用户八字五行格局提供定制化建议
- 从"通用五行理论"升级为"个人命盘分析"

---

## 二、V3 技术方案

### 2.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        用户前端                              │
│  ┌──────────────────────────────────────────────────┐      │
│  │ 新增：八字输入表单                                │      │
│  │ - 出生日期（公历）                                │      │
│  │ - 出生时间                                        │      │
│  │ - 性别、时区                                      │      │
│  └──────────────────┬───────────────────────────────┘      │
└─────────────────────┼──────────────────────────────────────┘
                      │ POST /advisor/ask/
                      │ query + bazi_data (JSON)
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                     Django 后端                              │
│  ┌──────────────────────────────────────────────────┐      │
│  │ views.py/ask_advisor()                           │      │
│  │ ├─ 接收用户问题                                  │      │
│  │ ├─ 接收八字数据                                  │      │
│  │ └─ 调用 generate_stream_response()               │      │
│  └──────────────────┬───────────────────────────────┘      │
│                     │                                        │
│  ┌──────────────────▼───────────────────────────────┐      │
│  │ 新增：bazi_mcp_client.py                         │      │
│  │ ├─ call_bazi_mcp() - 调用 MCP 工具              │      │
│  │ └─ format_bazi_for_llm() - 格式化排盘结果       │      │
│  └──────────────────┬───────────────────────────────┘      │
└─────────────────────┼──────────────────────────────────────┘
                      │ subprocess + JSON-RPC
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   Node.js MCP 工具                           │
│  ┌──────────────────────────────────────────────────┐      │
│  │ bazi-mcp (npm package)                           │      │
│  │ ├─ 计算天干地支（年月日时）                     │      │
│  │ ├─ 计算十神、纳音、神煞                         │      │
│  │ ├─ 计算大运                                      │      │
│  │ └─ 返回完整八字排盘                             │      │
│  └──────────────────┬───────────────────────────────┘      │
└─────────────────────┼──────────────────────────────────────┘
                      │ 返回八字数据
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Prompt Engineering                          │
│  ┌──────────────────────────────────────────────────┐      │
│  │ build_contextualized_prompt()                    │      │
│  │ ├─ 系统角色（五行顾问）                         │      │
│  │ ├─ 知识库上下文（L4 匹配）                      │      │
│  │ ├─ 【新增】八字排盘结果                         │      │
│  │ ├─ 对话历史                                      │      │
│  │ └─ 当前问题                                      │      │
│  └──────────────────┬───────────────────────────────┘      │
└─────────────────────┼──────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                Silicon Flow API (Qwen)                       │
│  接收：知识库 + 八字信息 + 问题                             │
│  返回：基于用户命盘的个性化五行建议                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、核心技术实现

### 3.1 新建文件：`bazi_mcp_client.py`

**功能：** MCP 协议客户端，调用 Node.js 八字工具

**关键代码：**
```python
def call_bazi_mcp(solar_datetime, gender=1):
    """通过 JSON-RPC 协议调用 bazi-mcp 工具"""
    
    # 1. 构建 JSON-RPC 请求
    mcp_request = {
        "jsonrpc": "2.0",
        "method": "tools/call",
        "params": {
            "name": "getBaziDetail",
            "arguments": {"solarDatetime": solar_datetime, "gender": gender}
        }
    }
    
    # 2. 启动 Node.js MCP 进程（stdio 通信）
    process = subprocess.Popen(
        ["npx", "bazi-mcp"],
        stdin=PIPE, stdout=PIPE, stderr=PIPE,
        encoding='utf-8'
    )
    
    # 3. 发送请求，接收响应
    stdout, stderr = process.communicate(input=json.dumps(mcp_request))
    
    # 4. 解析嵌套 JSON 响应
    response = json.loads(stdout)
    bazi_result = json.loads(response["result"]["content"][0]["text"])
    
    return bazi_result
```

**技术要点：**
- 使用 `subprocess.Popen` 实现跨语言进程通信（Python ↔ Node.js）
- 遵循 MCP（Model Context Protocol）的 JSON-RPC 2.0 规范
- UTF-8 编码处理，避免中文乱码
- 双重 JSON 解析，提取嵌套数据

---

### 3.2 修改前端：`index.html`

**新增：可折叠的八字输入表单**

```html
<div class="bazi-form-container">
    <div class="bazi-form-header">🔮 命理信息（可选）</div>
    <div class="bazi-form-content">
        <input type="date" id="birth-date" placeholder="出生日期">
        <input type="time" id="birth-time" placeholder="出生时间">
        <select id="gender">
            <option value="1">男</option>
            <option value="0">女</option>
        </select>
        <select id="timezone">
            <option value="+08:00">GMT+8 (北京时间)</option>
            ...
        </select>
    </div>
</div>
```

**JavaScript 逻辑：**
```javascript
// 收集八字数据
if (birthDateInput.value && birthTimeInput.value) {
    const solarDatetime = `${birthDate}T${birthTime}:00${timezone}`;
    baziData = {
        solar_datetime: solarDatetime,
        gender: parseInt(genderInput.value)
    };
    formData.append('bazi_data', JSON.stringify(baziData));
}
```

---

### 3.3 修改后端：`views.py`

#### 改动 1：接收八字数据
```python
def ask_advisor(request):
    user_query = request.POST.get('query', '').strip()
    session_id = request.POST.get('session_id', '').strip()
    
    # 新增：接收八字数据
    bazi_data_json = request.POST.get('bazi_data', '')
    bazi_data = json.loads(bazi_data_json) if bazi_data_json else None
    
    # 传递给生成函数
    return StreamingHttpResponse(
        generate_stream_response(user_query, session_id, bazi_data)
    )
```

#### 改动 2：调用 MCP 获取排盘
```python
def generate_stream_response(user_query, session_id, bazi_data=None):
    bazi_text = ""
    
    # 如果用户提供了八字数据
    if bazi_data:
        yield f"data: {json.dumps({'status': '正在计算八字排盘...'})}\n\n"
        
        # 调用 MCP 工具
        bazi_result = call_bazi_mcp(
            solar_datetime=bazi_data.get('solar_datetime'),
            gender=bazi_data.get('gender', 1)
        )
        
        if bazi_result:
            # 格式化为 LLM 可理解的文本
            bazi_text = format_bazi_for_llm(bazi_result)
            yield f"data: {json.dumps({'status': '八字排盘完成'})}\n\n"
```

#### 改动 3：Prompt 集成八字信息
```python
def build_contextualized_prompt(user_query, l4_info, history, bazi_text=""):
    system_role = """You are a Wu Xing decision advisor..."""
    
    topic_context = f"Topic: {l4_info['l4_name']}..."
    
    # 新增：八字信息段落
    bazi_context = ""
    if bazi_text:
        bazi_context = f"""
=== User's Bazi (Eight Characters) Analysis ===
{bazi_text}

Use this Bazi information to provide personalized Wu Xing guidance 
based on their birth chart's five elements balance.
===
"""
    
    # 组合完整 prompt
    full_prompt = system_role + topic_context + bazi_context + history + question
    return full_prompt
```

---

## 四、实际效果对比

### 4.1 无八字信息（V2）

**用户问题：** "What should I wear today?"

**系统回答：**
> "Wear beige or brown. Those tones will ground you—think stability. Add one gold piece for focus."

**特点：** 通用建议，适用所有人

---

### 4.2 有八字信息（V3）

**用户输入：**
- 问题："What should I wear today?"
- 八字：1998年7月31日 14:10 男

**系统获取排盘：**
```
八字：戊寅 己未 己卯 辛未
日主：己（土）
五行分布：土旺、木多、金弱、水缺
大运：24-33岁 壬戌（正财大运）
```

**系统回答：**
> "Wear white or silver. Your chart is Earth-heavy (己土日主，土旺), and Metal helps channel that grounded energy into clarity. You're in a Wealth luck cycle (壬戌正财大运), so add structure—think crisp white shirt, not loose earth tones. You don't need more stability; you need direction."

**特点：** 
- 基于实际八字分析（土旺需要金来泄）
- 结合当前大运（正财运需要条理）
- 建议精准，针对性强

---

## 五、技术难点与解决方案

| 难点 | 问题描述 | 解决方案 |
|------|---------|---------|
| **跨语言调用** | Python 调用 Node.js 工具 | subprocess + JSON-RPC 协议 |
| **中文乱码** | Windows GBK 编码冲突 | 强制 UTF-8 + errors='ignore' |
| **响应格式复杂** | MCP 返回三层嵌套 JSON | 逐层解析 result.content[0].text |
| **依赖管理** | Node.js 版本要求 v22+ | 文档说明 + 安装指引 |
| **超时控制** | MCP 进程可能卡死 | subprocess.communicate(timeout=10) |

---

## 六、部署要求

### 6.1 环境依赖
```bash
# Node.js 环境（必须 v22+）
node --version  # 应显示 v22.x.x

# 安装 MCP 工具
npm install -g bazi-mcp

# Python 依赖（无新增）
# 已有：requests, django, mysql-connector-python
```

### 6.2 测试命令
```bash
# 1. 测试 MCP 客户端
cd web_app/advisor
python bazi_mcp_client.py

# 2. 启动 Django 服务
cd web_app
python manage.py runserver

# 3. 浏览器访问
http://127.0.0.1:8000/advisor/
```

---

## 七、后续优化空间

### 7.1 功能增强
- [ ] 支持农历输入（目前只支持公历）
- [ ] 缓存八字结果（同一用户无需重复计算）
- [ ] 展示排盘详情（前端可视化八字图表）
- [ ] 流年运势分析（当前只用大运）

### 7.2 性能优化
- [ ] MCP 进程池（避免频繁启动 Node.js）
- [ ] 异步调用（MCP 计算耗时 1-2 秒）
- [ ] 错误重试机制（MCP 调用失败时重试）

### 7.3 用户体验
- [ ] 示例时间快捷填充（如"1990-01-01 12:00"）
- [ ] 八字结果预览（展示计算的八字，确认无误）

---

## 八、技术栈总结

| 组件 | 技术选型 | 版本 |
|------|---------|------|
| **后端框架** | Django | 5.2.8 |
| **八字计算** | bazi-mcp (Node.js) | latest |
| **进程通信** | subprocess + JSON-RPC 2.0 | - |
| **大模型** | Silicon Flow (Qwen3-32B) | - |
| **数据库** | MySQL 8.0 | 8.0 |
| **前端** | 原生 JS + Fetch API + SSE | - |

---

## 九、总结

**V3 版本核心价值：**
1. ✅ 从"通用五行建议"升级为"个性化命盘分析"
2. ✅ 技术突破：实现 Python ↔ Node.js 跨语言工具调用
3. ✅ 用户体验提升：八字输入 → 自动排盘 → 精准建议（全流程自动化）
